<div class="comment-card {% if comment.is_official %}comment-official{% endif %} {% if comment.ai_generated %}comment-ai{% endif %}"
     id="comment-{{ comment.id }}"
     style="--indent: {{ [level, 6] | min }};">

    <!-- Thread collapse line (left spine, click to collapse) -->
    <div class="comment-gutter" onclick="toggleThread('{{ comment.id }}')" title="Collapse thread"></div>

    <!-- Main comment content -->
    <div class="comment-body-wrap" id="comment-body-{{ comment.id }}">

        <!-- Header -->
        <div class="comment-header">

            <!-- Collapse toggle -->
            <button class="collapse-btn" onclick="toggleThread('{{ comment.id }}')"
                    id="toggle-icon-{{ comment.id }}" title="Collapse">‚àí</button>

            <!-- Avatar -->
            <div class="comment-avatar">
                {% if comment.ai_generated %}ü§ñ
                {% else %}{{ comment.username[0] | upper }}{% endif %}
            </div>

            <!-- Username -->
            <span class="comment-username">
                {% if comment.ai_generated %}AI Bot
                {% else %}u/{{ comment.username }}{% endif %}
            </span>

            <!-- Badges -->
            {% if comment.is_op %}
                <span class="cb op-badge">OP</span>
            {% endif %}
            {% if comment.is_official %}
                {% if comment.role == "ELECTED_REP" %}
                    <span class="cb rep-badge">üèõ Official</span>
                {% else %}
                    <span class="cb opp-badge">‚öñ Opposition</span>
                {% endif %}
            {% endif %}
            {% if comment.ai_generated %}
                <span class="cb ai-badge">AI</span>
            {% endif %}

            <!-- Vote inline (compact) -->
            <div class="comment-vote-inline">
                <form method="POST" action="{{ url_for('rep_policy.vote_comment_route', comment_id=comment.id) }}">
                    <input type="hidden" name="vote" value="1">
                    <input type="hidden" name="post_id" value="{{ post.id }}">
                    <button type="submit" class="cv-btn up {% if comment.user_vote == 1 %}active{% endif %}">‚ñ≤</button>
                </form>
                <span class="cv-score {% if (comment.score or 0) > 0 %}pos{% elif (comment.score or 0) < 0 %}neg{% endif %}">
                    {{ comment.score or 0 }}
                </span>
                <form method="POST" action="{{ url_for('rep_policy.vote_comment_route', comment_id=comment.id) }}">
                    <input type="hidden" name="vote" value="-1">
                    <input type="hidden" name="post_id" value="{{ post.id }}">
                    <button type="submit" class="cv-btn dn {% if comment.user_vote == -1 %}active{% endif %}">‚ñº</button>
                </form>
            </div>

            <!-- Time -->
            <span class="comment-time" title="{{ comment.created_at }}">{{ comment.time_ago }}</span>
        </div>

        <!-- Comment text -->
        <div class="comment-text {% if comment.ai_generated %}ai-markdown{% endif %}">{{ comment.content }}</div>

        <!-- Actions -->
        <div class="comment-actions">
            <button class="ca-btn" onclick="toggleReply('{{ comment.id }}')">‚Ü© Reply</button>
        </div>

        <!-- Reply form -->
        <form id="reply-form-{{ comment.id }}"
              method="POST"
              action="{{ url_for('rep_policy.comment', post_id=post.id) }}"
              class="reply-form-inner"
              style="display:none;">
            <input type="hidden" name="parent_comment_id" value="{{ comment.id }}">
            <div class="reply-input-row">
                <textarea name="content" rows="2" placeholder="Write a reply‚Ä¶" required></textarea>
                <button type="submit" class="reply-submit-btn">Reply ‚Üí</button>
            </div>
        </form>

        <!-- Nested replies -->
        <div class="comment-replies" id="replies-{{ comment.id }}">
            {% for reply in comment.replies %}
                {% set level = level + 1 %}
                {% set comment = reply %}
                {% include "policy/_comment.html" %}
            {% endfor %}
        </div>

    </div><!-- /comment-body-wrap -->
</div>