{% extends "base.html" %}
{% set title = "Issue Management" %}

{% block content %}
<div class="issue-management-page">

    <!-- =========================
         Page Header
    ========================== -->
    <div class="page-header">
        <h2>üßë‚Äç‚öñÔ∏è Issue Management</h2>
        <p class="page-subtext">
            Review, respond to, and resolve constituency issues.
        </p>
    </div>

    {% if issues %}
        {% for issue in issues %}
            <div class="issue-card">

                <!-- =========================
                     Issue Header
                ========================== -->
                <div class="issue-header">
                    <a
                        href="{{ url_for('citizen.issue_detail', issue_id=issue.id) }}"
                        class="issue-title"
                    >
                        {{ issue.title }}
                    </a>

                    <span class="status status-{{ issue.status|lower }}">
                        {{ issue.status }}
                    </span>
                </div>

                <!-- Meta -->
                <div class="issue-meta">
                    <span class="category">{{ issue.category }}</span>
                    <span class="date">Raised on {{ issue.created_at }}</span>
                </div>

                <!-- Description Preview -->
                <p class="issue-preview">
                    {{ issue.description[:150] }}
                    {% if issue.description|length > 150 %}...{% endif %}
                </p>

                <!-- =========================
                     Actions (STATUS-BASED)
                ========================== -->
                <div class="issue-actions">

                    <!-- ===== OPEN ===== -->
                    {% if issue.status == "Open" %}

                        <!-- ACCEPT -->
                        <form method="POST"
                              action="{{ url_for('representative.accept', issue_id=issue.id) }}"
                              class="action-form">

                            <label>Acceptance Note</label>
                            <textarea name="note" required
                                      placeholder="Explain why this issue is accepted"></textarea>

                            <label>Estimated Work Start</label>
                            <input type="datetime-local"
                                   name="estimated_start"
                                   required>

                            <button class="btn-primary">Accept Issue</button>
                        </form>

                        <!-- REJECT -->
                        <form method="POST"
                              action="{{ url_for('representative.reject', issue_id=issue.id) }}"
                              class="action-form">

                            <label>Rejection Reason</label>
                            <textarea name="note" required
                                      placeholder="Explain why this issue is rejected"></textarea>

                            <button class="btn-danger">Reject Issue</button>
                        </form>

                    {% endif %}

                    <!-- ===== ACCEPTED ===== -->
                    {% if issue.status == "Accepted" %}

                        <form method="POST"
                              action="{{ url_for('representative.progress', issue_id=issue.id) }}"
                              class="action-form">

                            <label>Progress Note</label>
                            <textarea name="note" required
                                      placeholder="Describe work started"></textarea>

                            <label>Estimated Completion</label>
                            <input type="datetime-local"
                                   name="estimated_completion"
                                   required>

                            <button class="btn-primary">Mark In Progress</button>
                        </form>

                    {% endif %}

                    <!-- ===== IN PROGRESS ===== -->
                    {% if issue.status == "In Progress" %}

                        <form method="POST"
                              action="{{ url_for('representative.resolve', issue_id=issue.id) }}"
                              class="action-form">

                            <label>Resolution Note</label>
                            <textarea name="note" required
                                      placeholder="Describe how the issue was resolved"></textarea>

                            <button class="btn-success">Mark Resolved</button>
                        </form>

                    {% endif %}

                    <!-- ===== RESOLVED ===== -->
                    {% if issue.status == "Resolved" %}
                        <div class="resolved-indicator">
                            ‚úÖ Awaiting citizen confirmation
                        </div>
                    {% endif %}

                    <!-- ===== REJECTED ===== -->
                    {% if issue.status == "Rejected" %}
                        <div class="rejected-indicator">
                            ‚ùå Issue Rejected
                        </div>
                    {% endif %}

                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <p>No issues found for your constituency.</p>
        </div>
    {% endif %}

</div>
{% endblock %}
